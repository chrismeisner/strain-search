<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cannabis Strain Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
	// Function to submit the prompt and receive the data
	async function submitPrompt() {
	  const inputField = document.getElementById('strainInput').value.trim();
	  const geneticsField = document.getElementById('geneticsInput').value.trim(); // New genetics input
	  const toneField = document.getElementById('toneSelect').value; // Get selected tone

	  if (!inputField) {
		alert('Please enter a strain name! üåø');
		return;
	  }

	  // Construct the prompt with detailed instructions for each data point
	  let prompt = `Provide detailed information about the cannabis strain, ${inputField}. Include the following fields:
	  - Popularity: How widely known and used is this strain? Include specific regions where it's most popular, if relevant.
	  - Genetics: Describe the lineage and heritage of the strain, including any crossbreeding with other strains. If possible, include parent strains.
	  - Category: Is the strain classified as Indica, Sativa, or Hybrid?
	  - Category Percentage: Provide the exact breakdown of the strain's Indica and Sativa percentages.
	  - Effects: List the common effects users experience with this strain, including both positive and negative effects, with emoji representations.
	  - Terpenes: Describe the main terpenes present in the strain and how they influence its flavor, smell, and potential effects.
	  - Notes: Mention any notable aspects of the strain, such as growing conditions, unique features, or special cultivation notes.
	  - Description: Provide a general description of the strain, its characteristics, and its usage. Write this in the tone of ${toneField}.
	  - Alternative Names: List any alternative or street names this strain is known by.
	  - Confidence Score: Rate the confidence level in the accuracy of the provided information.`;

	  // If user provided genetics information, add it to the prompt
	  if (geneticsField) {
		prompt += ` The genetics information for the strain is as follows: ${geneticsField}.`;
	  }

	  const responseDiv = document.getElementById('response');
	  responseDiv.innerHTML = 'Loading... ‚è≥';

	  try {
		const res = await fetch('/api/chat', {
		  method: 'POST',
		  headers: { 'Content-Type': 'application/json' },
		  body: JSON.stringify({ userInput: inputField, prompt }),
		});

		const data = await res.json();
		const fullResponse = data.response;
		console.log("üîç Full Response from API:", fullResponse);

		// Display the full raw response before parsing
		responseDiv.innerHTML = `<h3 class="text-lg font-semibold">Full Raw Response</h3>
		  <pre class="whitespace-pre-line bg-gray-100 p-4 rounded">${fullResponse}</pre>`;

		// Parse and display the parsed data
		const parsedData = parseResponse(fullResponse);
		displayParsedData(parsedData);
	  } catch (error) {
		console.error("‚ùå Error:", error.message);
		responseDiv.innerHTML = `<p class="text-red-500">Error: ${error.message} üö®</p>`;
	  }
	}

	// Function to parse the response
	function parseResponse(responseText) {
	  const parsedData = {
		popularity: extractSection(responseText, 'Popularity'),
		genetics: extractSection(responseText, 'Genetics'),
		category: extractSection(responseText, 'Category'),
		category_percentage: extractSection(responseText, 'Category Percentage'),
		effects: extractEffectsSection(responseText),
		terpenes: extractSection(responseText, 'Terpenes'),
		notes: extractSection(responseText, 'Notes'),
		description: extractSection(responseText, 'Description'),
		alternative_names: extractSection(responseText, 'Alternative Names'),
		confidence: extractSection(responseText, 'Confidence Score')
	  };

	  return parsedData;
	}

	// Utility function to extract sections from the text
	function extractSection(text, sectionName) {
	  const regex = new RegExp(`####\\s*${sectionName}\\s*\\n([^#]+)`, 'i');
	  const match = text.match(regex);
	  return match ? match[1].trim() : 'N/A';
	}

	// Utility function to handle effects extraction
	function extractEffectsSection(text) {
	  const regex = new RegExp(`####\\s*Effects\\s*\\n([\\s\\S]+?)(?=####|$)`, 'i');
	  const match = text.match(regex);
	  if (!match) return 'N/A';

	  // Separate positive and negative effects
	  const positiveRegex = /- Positive:\n([\s\S]+?)(?=\n- Negative:|\n####|$)/;
	  const negativeRegex = /- Negative:\n([\s\S]+?)(?=\n####|$)/;

	  const positiveMatch = match[1].match(positiveRegex);
	  const negativeMatch = match[1].match(negativeRegex);

	  return {
		positive: positiveMatch ? positiveMatch[1].trim() : 'N/A',
		negative: negativeMatch ? negativeMatch[1].trim() : 'N/A'
	  };
	}

	// Function to display the parsed data on the page
	function displayParsedData(parsedData) {
	  const parsedDiv = document.getElementById('parsed-data');

	  if (parsedData.error) {
		parsedDiv.innerHTML = `<p class="text-red-500">${parsedData.error}</p>`;
		return;
	  }

	  parsedDiv.innerHTML = `
		<h3 class="text-lg font-semibold mt-4">Parsed Data</h3>
		<p><span class="font-semibold">Popularity:</span> ${parsedData.popularity}</p>
		<p><span class="font-semibold">Genetics:</span> ${parsedData.genetics}</p>
		<p><span class="font-semibold">Category:</span> ${parsedData.category}</p>
		<p><span class="font-semibold">Category Percentage:</span> ${parsedData.category_percentage}</p>
		<p><span class="font-semibold">Effects:</span> Positive: ${parsedData.effects.positive}, Negative: ${parsedData.effects.negative}</p>
		<p><span class="font-semibold">Terpenes:</span> ${parsedData.terpenes}</p>
		<p><span class="font-semibold">Notes:</span> ${parsedData.notes}</p>
		<p><span class="font-semibold">Description:</span> ${parsedData.description}</p>
		<p><span class="font-semibold">Alternative Names:</span> ${parsedData.alternative_names}</p>
		<p><span class="font-semibold">Confidence Score:</span> ${parsedData.confidence}</p>`;
	}

	// Detect the Enter key press and submit the form
	function handleKeyPress(event) {
	  if (event.key === 'Enter') {
		event.preventDefault(); // Prevent default form submission
		submitPrompt(); // Trigger the same function as the button click
	  }
	}
  </script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col items-center p-4">
  <h1 class="text-3xl font-bold text-green-600 my-4 text-center">Cannabis Strain Explorer üåø</h1>
  <p class="text-center max-w-md mb-6">Enter a cannabis strain name below to test the parsed data and optional genetics information.</p>

  <!-- Input for cannabis strain name -->
  <div class="w-full max-w-md">
	<input id="strainInput" type="text" placeholder="Enter strain name (e.g., Durban Poison)"
	  class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-green-400"
	  onkeydown="handleKeyPress(event)">
  </div>

  <!-- Optional input for genetic information -->
  <div class="w-full max-w-md">
	<input id="geneticsInput" type="text" placeholder="Enter genetic info (optional)"
	  class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-green-400">
  </div>

  <!-- Tone selection dropdown -->
  <div class="w-full max-w-md mb-4">
	<select id="toneSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400">
	  <option value="Cheech and Chong">Cheech and Chong</option>
	  <option value="Snoop Dog">Snoop Dog</option>
	  <option value="Friendly and Knowledgable Bud-Tender, specialing in communicating with the casual cannabis user">Budtender</option>
	  <option value="Valley Girl inspired by Paris Hilton">Valley Girl</option>
	  <option value="A mystical Gnome who speeaks in rhymes and riddles">Gnome</option>

	</select>
  </div>

  <button onclick="submitPrompt()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg transition">
	Search
  </button>

  <!-- Display full raw response -->
  <div id="response" class="w-full max-w-md bg-white shadow-lg rounded-lg p-6 mt-6"></div>

  <!-- Display parsed data -->
  <div id="parsed-data" class="w-full max-w-md mt-6"></div>
</body>
</html>
